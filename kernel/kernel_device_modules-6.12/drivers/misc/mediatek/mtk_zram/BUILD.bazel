load("//build/bazel_mgk_rules:mgk_ddk_ko.bzl", "define_mgk_ddk_ko")
load("//build/kernel/kleaf:kernel.bzl", "ddk_headers")
load("@mgk_info//:kernel_version.bzl", "kernel_version")

package(
    default_visibility = [
        "//visibility:public",
    ],
)

filegroup(
    name = "ddk_kconfigs",
    srcs = glob([
        "**/Kconfig",
    ]),
)

filegroup(
    name = "ddk_makefile",
    srcs = glob([
        "**/Makefile",
        "**/Kbuild",
        "**/*.c",
        "**/*.h",
    ]),
)

define_mgk_ddk_ko(
    name = "mtk_hwz",
    srcs = [
    "hw/zram_engine.c",
    "hw/engine_dst_copy.c",
    "hw/helpers.c",
    "hw/engine_control.c",
    "hw/engine_gears_control.c",
    ],
    conditional_srcs = {
        "CONFIG_HWCOMP_SUPPORT_NO_DST_COPY": {
	    True: [
	        "hw/engine_no_dst_copy.c",
	    ],
	},
    },
    hdrs = glob(["**/*.h"]),
    ko_deps = [
	"//kernel_device_modules-{}/drivers/misc/mediatek/iommu:mtk_iommu_util".format(kernel_version),
	"//kernel_device_modules-{}/drivers/thermal/mediatek:thermal_interface".format(kernel_version),
	"//kernel_device_modules-{}/drivers/clk/mediatek:clk-common".format(kernel_version),
    ],
    includes = ["."],
    header_deps = [
        "//kernel_device_modules-{}/drivers/misc/mediatek/iommu:iommu_misc_headers".format(kernel_version),
        "//kernel_device_modules-{}/drivers/thermal/mediatek:thermal_headers".format(kernel_version),
	"//kernel_device_modules-{}/drivers/clk/mediatek:headers".format(kernel_version),
    ],
    copts = [
	"-I$(srctree)/$(src)",
	"-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/mtk_zram",
	"-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/mtk_zram/hw",
    ],
    local_defines = [
#       "FPGA_EMULATION",       # For FPGA emulation
#   	"ENGINE_BYPASS_SMMU",   # Bypass SMMU
#   	"ZRAM_ENGINE_DEBUG",    # Dump debug log
    ],
)

define_mgk_ddk_ko(
    name = "mtk_zram",
    srcs = [
    "mtk_zram_drv.c",
    "zcomp.c",
    ],
    hdrs = glob(["**/*.h"]),
    ko_deps = [
        "//kernel_device_modules-{}/drivers/misc/mediatek/kcompressd:kcompressd".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/mtk_zram:mtk_hwz".format(kernel_version),
    ],
    includes = ["."],
    copts = [
    "-I$(srctree)/mm",
    "-I$(srctree)/$(src)",
    "-I$(DEVICE_MODULES_PATH)/include/linux",
    "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/mtk_zram",
    ],
)
