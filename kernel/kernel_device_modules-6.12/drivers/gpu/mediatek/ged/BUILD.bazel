load("//build/bazel_mgk_rules:mgk_ddk_ko.bzl", "define_mgk_ddk_ko")
load("//build/kernel/kleaf:kernel.bzl", "ddk_headers")
load("@mgk_info//:kernel_version.bzl", "kernel_version")
load("@mgk_info//:dict.bzl", "DEFCONFIG_OVERLAYS",)

package(
    default_visibility = [
        "//visibility:public",
    ],
)

filegroup(
    name = "srcs",
    srcs = glob([
        "**/Makefile",
        "**/Kbuild",
        "**/*.c",
        "**/*.h",
    ]),
)

filegroup(
    name = "ddk_kconfigs",
    srcs = glob([
        "**/Kconfig",
    ]),
)

ddk_headers(
    name = "ged_public_headers",
    hdrs = [
        "include/ged_async.h",
        "include/ged_base.h",
        "include/ged_bridge.h",
        "include/ged_bridge_id.h",
        "include/ged_dcs.h",
        "include/ged_debugFS.h",
        "include/ged_dvfs.h",
        "include/ged_eb.h",
        "include/ged_global.h",
        "include/ged_ski.h",
        "include/ged_gpu_bm.h",
        "include/ged_gpufreq.h",
        "include/ged_gpufreq_v1.h",
        "include/ged_gpufreq_v2.h",
        "include/ged_gpu_memsys.h",
        "include/ged_gpu_slc.h",
        "include/ged_gpu_tuner.h",
        "include/ged.h",
        "include/ged_hal.h",
        "include/ged_hashtable.h",
        "include/ged_kpi.h",
        "include/ged_log.h",
        "include/ged_mali_event.h",
        "include/ged_monitor_3D_fence.h",
        "include/ged_notify_sw_vsync.h",
        "include/ged_sysfs.h",
        "include/ged_thread.h",
        "include/ged_tracepoint.h",
        "include/ged_type.h",
    ],
    includes = [
        "include",
    ],
)

define_mgk_ddk_ko(
    name = "ged",
    srcs = [
        "src/ged.c",
        "src/ged_base.c",
        "src/ged_main.c",
        "src/ged_sysfs.c",
        "src/ged_hal.c",
        "src/ged_log.c",
        "src/ged_bridge.c",
        "src/ged_monitor_3D_fence.c",
        "src/ged_notify_sw_vsync.c",
        "src/ged_hashtable.c",
        "src/ged_thread.c",
        "src/ged_thread.h",
        "src/ged_ge.c",
        "src/ged_ge.h",
        "src/ged_dvfs.c",
        "src/ged_ski.c",
        "src/ged_gpu_tuner.c",
        "src/ged_kpi.c",
        "src/ged_eb.c",
        "src/ged_gpu_bm.c",
        "src/ged_gpu_slc.c",
        "src/ged_mali_event.c",
        "src/ged_gpu_memsys.c",
    ],
    header_deps = [
        "//kernel_device_modules-{}/drivers/gpu/mediatek/gpufreq/v2:gpufreq_public_headers".format(kernel_version),
        "//kernel_device_modules-{}/drivers/gpu/mediatek/gpueb:gpueb_public_headers".format(kernel_version),
        "//kernel_device_modules-{}/drivers/gpu/mediatek/mt-plat:gpu_utility_headers".format(kernel_version),
        "//kernel_device_modules-{}/drivers/gpu/mediatek/gpufreq:mtk_gpufreq_headers".format(kernel_version),
        "//kernel_device_modules-{}/drivers/gpu/mediatek/gpufreq/v2_legacy:gpufreq_public_headers".format(kernel_version),
    ],
    ko_deps = [
        "//kernel_device_modules-{}/drivers/thermal/mediatek:thermal_interface".format(kernel_version),
        "//kernel_device_modules-{}/drivers/gpu/mediatek/gpu_bm:mtk_gpu_qos".format(kernel_version),
        "//kernel_device_modules-{}/drivers/gpu/mediatek/hal:mtk_gpu_hal".format(kernel_version),
        "//kernel_device_modules-{}/drivers/gpu/mediatek/gpueb:mtk_gpueb".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/sspm/v3:sspm_v3".format(kernel_version),
        "//kernel_device_modules-{}/drivers/gpu/drm/mediatek/mediatek_v2:mediatek-drm".format(kernel_version),
        "//kernel_device_modules-{}/drivers/dma-buf/heaps:system_heap".format(kernel_version),
        "//kernel_device_modules-{}/drivers/soc/mediatek:mtk_tinysys_ipi".format(kernel_version),
    ] + ([
        "//kernel_device_modules-{}/drivers/gpu/mediatek/gpufreq/v2_legacy:mtk_gpufreq_wrapper_legacy".format(kernel_version),
         "//kernel_device_modules-{}/drivers/gpu/mediatek/gpufreq/v2_legacy:mtk_gpufreq_mt6789".format(kernel_version),
    ] if "entry_level.config" in DEFCONFIG_OVERLAYS else [
        "//kernel_device_modules-{}/drivers/gpu/mediatek/gpufreq/v2:mtk_gpufreq_wrapper".format(kernel_version),
    ]),
    hdrs = [
        "include/ged_async.h",
        "include/ged_base.h",
        "include/ged_bridge.h",
        "include/ged_bridge_id.h",
        "include/ged_dcs.h",
        "include/ged_debugFS.h",
        "include/ged_dvfs.h",
        "include/ged_eb.h",
        "include/ged_global.h",
        "include/ged_ski.h",
        "include/ged_gpu_bm.h",
        "include/ged_gpufreq.h",
        "include/ged_gpufreq_v1.h",
        "include/ged_gpufreq_v2.h",
        "include/ged_gpu_memsys.h",
        "include/ged_gpu_slc.h",
        "include/ged_gpu_tuner.h",
        "include/ged.h",
        "include/ged_hal.h",
        "include/ged_hashtable.h",
        "include/ged_kpi.h",
        "include/ged_log.h",
        "include/ged_mali_event.h",
        "include/ged_monitor_3D_fence.h",
        "include/ged_notify_sw_vsync.h",
        "include/ged_sysfs.h",
        "include/ged_thread.h",
        "include/ged_tracepoint.h",
        "include/ged_type.h",
    ],
    includes = [
        "include",
    ],
    conditional_srcs = {
        "CONFIG_MTK_GPUFREQ_V2": {
            True: [
                "src/ged_gpufreq_v2.c",
                "src/ged_dcs.c",
            ],
            False: [
                "src/ged_gpufreq_v1.c",
            ],
        },
        "CONFIG_DEBUG_FS": {
            True: [
                "src/ged_debugFS.c",
            ],
        },
        "CONFIG_SYNC_FILE": {
            True: [
                "src/ged_sync.c",
            ],
        },
    },
    local_defines = [
#        "MTK_CPUFREQ",
#        "GED_KPI_DEBUG",
#        "GED_DEBUG_LOG",
        "MTK_GPUFREQ_V2",
        "MTK_GED_KPI",
        "MET_USER_EVENT_SUPPORT",
        "MTK_GPU_DVFS",
        "GED_DVFS_DEBUG_BUF",
        "MTK_GPU_BM_2",
        "CONFIG_MTK_GPU_FW_IDLE",
        "CONFIG_MTK_GPU_APO_SUPPORT",
        "CONFIG_MTK_GPU_POWER_ON_OFF_TEST",
        "MTK_GPU_SLC_POLICY",
        "MTK_GPU_MEMSYS_UTIL",
        "GED_SKI_SUPPORT",
    ],
    copts = [
        "-I$(DEVICE_MODULES_PATH)/include",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/include",
        "-I$(DEVICE_MODULES_PATH)/drivers/gpu/mediatek/ged/include",
        "-I$(DEVICE_MODULES_PATH)/drivers/gpu/mediatek/ged/include/platform",
        "-I$(DEVICE_MODULES_PATH)/drivers/gpu/mediatek/hal",
        "-I$(srctree)/drivers/gpu/mediatek",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/lcm/inc",
        "-I$(srctree)/drivers/gpu/mediatek/gpufreq",
        "-I$(srctree)/drivers/gpu/mediatek/mt-plat",
        "-I$(DEVICE_MODULES_PATH)/drivers/gpu/mediatek/gpufreq/v1/include",
        "-I$(DEVICE_MODULES_PATH)/drivers/gpu/mediatek/gpufreq/v2/include",
        "-I$(DEVICE_MODULES_PATH)/drivers/gpu/mediatek/gpufreq/v2_legacy/",
        "-I$(DEVICE_MODULES_PATH)/drivers/gpu/mediatek/gpufreq/v2_legacy/include",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/performance/fpsgo_v3",
#        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/video/$(MTK_PLATFORM)/videox",
        "-I$(DEVICE_MODULES_PATH)/drivers/gpu/drm/mediatek/mediatek_v2",
        "-I$(DEVICE_MODULES_PATH)/drivers/gpu/mediatek/gpueb/include",
        "-I$(DEVICE_MODULES_PATH)/drivers/dma-buf/heaps",
        "-I$(DEVICE_MODULES_PATH)/drivers/thermal/mediatek",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/cmdq/v3",
        "-I$(DEVICE_MODULES_PATH)/drivers/gpu/mediatek/gpueb",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/sspm",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/sspm/v2",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/qos",
        "-I$(DEVICE_MODULES_PATH)/drivers/gpu/mediatek/gpu_bm",
    ],
)

define_mgk_ddk_ko(
    name = "mtk_ged_mt6991",
    out = "mtk_ged_mt6991.ko",
    srcs = [
        "src/platform/ged_mt6991.c"
    ]+glob(["**/include/*.h",
        "include/platform/ged_mt6991.h"]),

    includes = ["include"],

    ko_deps = [
        "//kernel_device_modules-{}/drivers/gpu/mediatek/ged:ged".format(kernel_version),
    ],

    copts = [
        "-I$(DEVICE_MODULES_PATH)/drivers/gpu/mediatek/ged/include/platform/",
        "-I$(DEVICE_MODULES_PATH)/drivers/gpu/mediatek/ged/include/",
    ],
)

define_mgk_ddk_ko(
    name = "mtk_ged_mt6993",
    out = "mtk_ged_mt6993.ko",
    srcs = [
        "src/platform/ged_mt6993.c"
    ]+glob(["**/include/*.h",
        "include/platform/ged_mt6993.h"]),

    includes = ["include"],

    ko_deps = [
        "//kernel_device_modules-{}/drivers/gpu/mediatek/ged:ged".format(kernel_version),
    ],

    copts = [
        "-I$(DEVICE_MODULES_PATH)/drivers/gpu/mediatek/ged/include/platform/",
        "-I$(DEVICE_MODULES_PATH)/drivers/gpu/mediatek/ged/include/",
    ],
)
