load("//build/bazel_mgk_rules:mgk_ddk_ko.bzl", "define_mgk_ddk_ko")
load("@mgk_info//:kernel_version.bzl","kernel_version")
load("//build/kernel/kleaf:kernel.bzl", "ddk_headers")

config_setting(
    name = "trustonic_tee",
    define_values = {"CONFIG_TRUSTONIC_TEE_SUPPORT": "n"},
)

package(
    default_visibility = [
        "//visibility:public",
    ],
)

filegroup(
    name = "ddk_kconfigs",
    srcs = glob([
        "**/Kconfig",
    ]),
)

filegroup(
    name = "ddk_makefile",
    srcs = glob([
        "**/Makefile",
        "**/Kbuild",
        "**/*.c",
        "**/*.h",
    ]),
)

define_mgk_ddk_ko(
    name = "mediatek-drm",
    srcs = [
        "mtk_drm_drv.c",
        "mtk_disp_tdshp.c",
        "mtk_disp_color.c",
        "mtk_disp_ccorr.c",
        "mtk_disp_c3d.c",
        "mtk_disp_gamma.c",
        "mtk_disp_aal.c",
        "mtk_disp_dither.c",
        "mtk_disp_chist.c",
        "mtk_disp_ovl.c",
        "mtk_disp_rdma.c",
        "mtk_disp_mdp_rdma.c",
        "mtk_disp_rsz.c",
        "mtk_disp_mdp_rsz.c",
        "mtk_disp_wdma.c",
        "mtk_drm_crtc.c",
        "mtk_drm_ddp.c",
        "mtk_drm_ddp_addon.c",
        "mtk_drm_ddp_comp.c",
        "mtk_drm_fb.c",
        "mtk_drm_gem.c",
        "mtk_drm_plane.c",
        "mtk_dsi.c",
        "mtk_mipi_tx.c",
        "mtk_writeback.c",
        "mtk_fence.c",
        "mtk_drm_session.c",
        "mtk_dump.c",
        "mtk_debug.c",
        "mtk_layering_rule.c",
        "mtk_layering_rule_base.c",
        "mtk_rect.c",
        "mtk_drm_mmp.c",
        "mtk_drm_trace.c",
        "mtk_drm_helper.c",
        "mtk_drm_lowpower.c",
        "mtk_disp_postmask.c",
        "mtk_drm_assert.c",
        "mtk_drm_fbconsole.c",
        "mtk_disp_recovery.c",
        "mtk_disp_pmqos.c",
        "mtk_disp_dsc.c",
        "mtk_disp_cm.c",
        "mtk_disp_spr.c",
        "mtk_disp_postalign.c",
        "mtk_disp_oddmr/mtk_disp_oddmr_parse_data.c",
        "mtk_disp_oddmr/mtk_disp_oddmr.c",
        "mtk_drm_arr.c",
        "mtk_disp_merge.c",
        "mtk_dmdp_aal.c",
        "mtk_fbconfig_kdebug.c",
        "mtk_disp_y2r0.c",
        "mtk_disp_dlo_async.c",
        "mtk_disp_dli_async.c",
        "mtk_disp_inlinerotate.c",
        "mtk_mmlsys_bypass_mode.c",
        "mtk_lease.c",
        "platform/mtk_drm_6835.c",
        "platform/mtk_drm_6789.c",
        "mtk_disp_pq_helper.c",
        "mtk_disp_vidle.c",
        "mtk_disp_r2y0.c",
        "mtk_disp_ovl_exdma.c",
        "mtk_disp_ovl_blender.c",
        "mtk_disp_ovl_outproc.c",
        "mtk_disp_vdisp_ao.c",
        "mtk_dp_intf.c",
        "mtk_dp.c",
        "mtk_dp_hal.c",
        "mtk_dp_debug.c",
        "mtk_disp_bdg.c",
        "mtk_disp_bwm.c",
        "mtk_disp_dbi_count.c",
        "mtk_disp_relay.c",
        "mtk_dvo.c",
        "mtk_dsi_lpc.c",
        "mtk_disp_dbgtp.c",
        "mtk_notify.c",
    ],
    includes = [
        ".",
        "$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/include",
        "$(srctree)/drivers"
    ],
    hdrs = glob([
        "mt-plat/aee.h",
        "mtk_irq_mon.h",
        "clk-fmeter.h",
        "extcon.h",
        "drm_internal.h",
        "cmdq-util.h",
        "mtk-mml-dpc.h",
        "mtk-mml.h",
        "mailbox/cmdq-sec.h",
        "**/*.h",
        "mtk_dpc.h",
        "mtk_notify.h",
    ]),
    local_defines = select({
            "@mgk_internal//:mgk_internal_setting" : [
                "DRM_DSI_UNDERRUN_AEE=1",
                "DISP_COMPLEX_AEE_DUMP=1",
                "DISP_VIDLE_ENABLE=1"
            ],
            "//conditions:default" : [
            ]
    }) + [
        "DRM_PARTIAL_UPDATE=1",
        "DRM_RETRIGGER_ENABLE=1",
        "DISP_MDP_COLOR_ON=1",
        "DISP_STASH_ENABLE=1",
    ] + select({
        ":trustonic_tee": [],
        "//conditions:default": [
            "HDCP_TEE_TYPE_TRUSTONIC=1",
            "DPTX_HDCP_ENABLE=1",
        ],
    }),
    copts = [
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/dramc/$(MTK_PLATFORM)",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/smi/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/mminfra/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/mmp/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/spi_slave_drv/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/cmdq/bridge/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/clkbuf/src/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/base/power/include/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/mmdvfs/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/pmic/",
        "-I$(DEVICE_MODULES_PATH)/drivers/iommu/",
        "-I$(DEVICE_MODULES_PATH)/drivers/devfreq/",
        "-I$(srctree)/drivers/gpu/drm/",
        "-I$(srctree)/drivers/gpu/drm/display/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/include/mt-plat/$(MTK_PLATFORM)/include/mach/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/include/mt-plat/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/leds/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/leds/$(MTK_PLATFORM)",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/cmdq/mailbox/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/iommu/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/mtk-interconnect/",
        "-I$(DEVICE_MODULES_PATH)/sound/soc/mediatek/common/",
        "-I$(srctree)/drivers/gpu/drm/mediatek",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/slbc/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/cmdq/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/tinysys_scmi/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/vcp/rv_v2/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/vcp/include",
        "-I$(DEVICE_MODULES_PATH)/drivers/dma-buf/heaps/",
        "-I$(DEVICE_MODULES_PATH)/drivers/gpu/drm/mediatek/mml",
        "-I$(DEVICE_MODULES_PATH)/drivers/iommu/arm/arm-smmu-v3",
        "-I$(DEVICE_MODULES_PATH)/drivers/gpu/drm/mediatek/dpc",
        "-I$(DEVICE_MODULES_PATH)/drivers/clk/mediatek",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/include",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/extcon",
        "-I$(DEVICE_MODULES_PATH)/drivers/clk/mediatek",
        "-Wno-unused-but-set-parameter",
        "-Wno-dangling-else",
        "-Wno-unused-variable",
        "-Wno-unused-label",
        "-Wno-uninitialized",
        "-Wno-shift-op-parentheses",
        "-Wno-format",
        "-Wno-format-insufficient-args",
        "-Wno-unused-function",
        "-Wno-missing-braces",
        "-Wno-macro-redefined",
        "-Wno-frame-larger-than",
        "-Wno-undefined-internal",
        "-Wno-implicit-function-declaration",
        "-Wno-switch",
        "-Wno-misleading-indentation",
        "-Wno-int-conversion",
        "-Wno-visibility",
        "-Wno-c23-extensions",
        "-Wno-implicit-fallthrough",
        "-Wno-compare-distinct-pointer-types",
        "-Wno-logical-op-parentheses",
        #"-Wno-error",
    ],
    ko_deps = [
        "//kernel_device_modules-{}/drivers/tee/gud:mcDrvModule".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/mmp/src:mmprofile".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/aee/aed:aee_aed".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/tinysys_scmi:tinysys-scmi".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/mtk-interconnect:mtk-icc-core".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/cmdq/mailbox:mtk-cmdq-drv-ext".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/mminfra:mtk-mminfra-util".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/mminfra:mtk-mminfra-debug".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/mm_monitor:mtk-mm-monitor-controller".format(kernel_version),
        "//kernel_device_modules-{}/drivers/gpu/drm/mediatek/mml:mtk-mml".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/vcp/rv_v2:vcp_status_v2".format(kernel_version),
        "//kernel_device_modules-{}/drivers/memory/mediatek:mtk_dramc".format(kernel_version),
        "//kernel_device_modules-{}/drivers/leds:leds-mtk".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/slbc:mtk_slbc".format(kernel_version),
        "//kernel_device_modules-{}/drivers/dma-buf/heaps:system_heap".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/clkbuf:clkbuf".format(kernel_version),
        ":mtk_sync",
        ":mtk_panel_ext",
        ":mtk_disp_notify",
        "//kernel_device_modules-{}/sound/soc/mediatek/common:mtk-afe-external".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/iommu:iommu_debug".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/aee/mrdump:mrdump".format(kernel_version),
        "//kernel_device_modules-{}/drivers/clk/mediatek:clk-common".format(kernel_version),
        "//kernel_device_modules-{}/drivers/memory:mtk-smi".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/smi:mtk-smi-dbg".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/irq_monitor:irq_monitor".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/mmdvfs:mtk-mmdvfs-debug".format(kernel_version),
        "//kernel_device_modules-{}/drivers/soc/mediatek:mtk-mmdvfs".format(kernel_version),
        "//kernel_device_modules-{}/drivers/interconnect/mediatek:mmqos-common".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/hwccf:hwccf".format(kernel_version),
        "//kernel_device_modules-{}/drivers/memory/mediatek:emi".format(kernel_version),
    ],
    header_deps = [
        "//kernel_device_modules-{}/drivers/tee/gud:mobicore_public_hdrs".format(kernel_version),
        "//kernel_device_modules-{}/drivers/iommu/arm/arm-smmu-v3:smmu_public_headers".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/aee/aed:headers".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/cmdq/mailbox:ddk_public_headers".format(kernel_version),
        "//kernel_device_modules-{}/drivers/gpu/drm/mediatek/mml:mml_public_headers".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/vcp/rv_v2:vcp_status_v2_headers".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/vcp/include:vcp_public_headers".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/iommu:iommu_misc_headers".format(kernel_version),
        "//kernel_device_modules-{}/sound/soc/mediatek/common:ddk_public_headers".format(kernel_version),
        "//kernel_device_modules-{}/drivers/clk/mediatek:headers".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/scp/include:scp_public_headers".format(kernel_version),
        "//kernel_device_modules-{}/drivers/gpu/drm/mediatek/dpc:ddk_public_headers".format(kernel_version),
    ],
    conditional_srcs = {
        "CONFIG_TRUSTONIC_TEE_SUPPORT": {
            True: [
                "ca/tlcDpHdcp.c",
                "mtk_dp_hdcp1x.c",
                "mtk_dp_hdcp2.c",
            ],
        },
        "CONFIG_TEEGRIS_TEE_SUPPORT": {
            True: [
                "ca/tlcDpHdcp.c",
                "mtk_dp_hdcp1x.c",
                "mtk_dp_hdcp2.c",
            ],
        },
        "CONFIG_DRM_MEDIATEK_DEBUG_FS": {
            True: ["mtk_drm_debugfs.c"],
        },
        "CONFIG_DRM_MEDIATEK_DPTX_AUTO": {
            True: [
                "mtk_drm_dp/mtk_drm_dp_intf.c",
                "mtk_drm_dp/mtk_drm_dp.c",
                "mtk_drm_dp/mtk_drm_dp_mst_drv.c",
                "mtk_drm_dp/mtk_drm_dp_mst.c",
                "mtk_drm_dp/mtk_drm_dp_debug.c"],
            False: [
                "mtk_dp_intf.c",
                "mtk_dvo.c",
                "mtk_dp.c",
                "mtk_dp_hal.c",
                "mtk_dp_debug.c",
            ],
        },
        "CONFIG_DRM_MEDIATEK_CEC": {
            True: ["mtk_cec.c"],
        },
        "CONFIG_DRM_MEDIATEK_HDMI": {
            True: ["mtk_dpi.c"],
        },
        "CONFIG_DRM_FBDEV_EMULATION": {
            True: ["mtk_drm_fbdev.c"],
        },
        "CONFIG_DRM_MEDIATEK_EDPTX_AUTO_SUPPORT": {
            True: [
                "mtk_drm_edp/mtk_dvo.c",
                "mtk_drm_edp/mtk_drm_edp_phy.c",
                "mtk_drm_edp/mtk_drm_edp.c",
            ],
        },
    },
)

define_mgk_ddk_ko(
    name = "mtk_disp_sec",
    srcs = [],
    conditional_srcs = {
        "CONFIG_MTK_TRUSTED_MEMORY_SUBSYSTEM": {
            True: ["mtk_disp_sec.c"],
        },
    },
    hdrs = glob([
        "**/*.h",
    ]),
    copts = [
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/include/mt-plat/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/include/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/mmp/",
        "-I$(DEVICE_MODULES_PATH)/drivers/dma-buf/heaps/",
    ],
    ko_deps = [
        "//kernel_device_modules-{}/drivers/misc/mediatek/mmp/src:mmprofile".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/aee/aed:aee_aed".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/tinysys_scmi:tinysys-scmi".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/mtk-interconnect:mtk-icc-core".format(kernel_version),
        "//kernel_device_modules-{}/drivers/gpu/drm/mediatek/mml:mtk-mml".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/slbc:mtk_slbc".format(kernel_version),
        "//kernel_device_modules-{}/drivers/dma-buf/heaps:system_heap".format(kernel_version),
        "//kernel_device_modules-{}/drivers/dma-buf/heaps:mtk_sec_heap".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/cmdq/mailbox:mtk-cmdq-drv-ext".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/cmdq/mailbox:cmdq-sec-drv".format(kernel_version),
        ":mediatek-drm",
    ],
    header_deps = [
        "//kernel_device_modules-{}/drivers/gpu/drm/mediatek/dpc:ddk_public_headers".format(kernel_version),
    ],
    includes = ["."],
)

define_mgk_ddk_ko(
    name = "mtk_aod_scp",
    srcs = [],
    conditional_srcs = {
        "CONFIG_MTK_TINYSYS_SCP_CM4_SUPPORT": {
            True: ["mtk_aod_scp.c"],
        },
    },
    hdrs = glob([
        "**/*.h",
    ]),
    copts = [
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/include/mt-plat/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/include/",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/mmp/",
        "-I$(DEVICE_MODULES_PATH)/drivers/dma-buf/heaps/",
        "-I$(DEVICE_MODULES_PATH)/drivers/iommu/arm/arm-smmu-v3/",
    ],
    ko_deps = [
        "//kernel_device_modules-{}/drivers/misc/mediatek/mmp/src:mmprofile".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/aee/aed:aee_aed".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/tinysys_scmi:tinysys-scmi".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/mtk-interconnect:mtk-icc-core".format(kernel_version),
        "//kernel_device_modules-{}/drivers/gpu/drm/mediatek/mml:mtk-mml".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/slbc:mtk_slbc".format(kernel_version),
        "//kernel_device_modules-{}/drivers/dma-buf/heaps:system_heap".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/cmdq/mailbox:mtk-cmdq-drv-ext".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/scp/rv:scp".format(kernel_version),
        "//kernel_device_modules-{}/drivers/soc/mediatek:mtk_tinysys_ipi".format(kernel_version),
        ":mediatek-drm",
    ],
    header_deps = [
        "//kernel_device_modules-{}/drivers/gpu/drm/mediatek/dpc:ddk_public_headers".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/scp/include:scp_public_headers".format(kernel_version),
        "//kernel_device_modules-{}/drivers/iommu/arm/arm-smmu-v3:smmu_public_headers".format(kernel_version),
    ],
    includes = ["."],
)

define_mgk_ddk_ko(
    name = "mtk_panel_ext",
    srcs = [
        "mtk_panel_ext.c",
    ],
    hdrs = [
        "mtk_panel_ext.h",
    ],
    includes = ["."],
)

define_mgk_ddk_ko(
    name = "mtk_sync",
    srcs = [
        "mtk_sync.c",
    ],
    hdrs = [
        "mtk_sync.h",
    ],
    includes = ["."],
)


define_mgk_ddk_ko(
    name = "mtk_disp_notify",
    srcs = [
        "mtk_disp_notify.c",
        "mtk_log.h",
    ],

    hdrs = [
        "mtk_disp_notify.h",
    ] + glob([
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/include/mt-plat/aee.h",
    ]),

    includes = [
        "include",
    ],

    ko_deps = [
        "//kernel_device_modules-{}/drivers/misc/mediatek/mme:mme".format(kernel_version),
    ],

    copts = [
        "-I$(DEVICE_MODULES_PATH)/drivers/gpu/drm/mediatek/mediatek_v2",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/include/mt-plat",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/mme",
    ],
)

# add ddk_headers to export headers for other modules to use in the future
ddk_headers(
    name = "ddk_public_headers",
    includes = ["."],
    hdrs = glob(["**/*.h"]), # export all headers for other modules to use
)
