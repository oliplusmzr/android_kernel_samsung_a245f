# SPDX-License-Identifier: GPL-2.0-only
#
# Trusty driver
#

menu "Trusty driver"

config TRUSTY
	tristate "Trusty core driver"
	depends on ARM || ARM64
	help
	  Trusty is a secure OS that provides a Trusted Execution Environment
	  (TEE) for Android.  Trusty runs on the same processor as Linux but is
	  isolated from the rest of the system by both hardware and software.

	  This option enables the core part of the Linux kernel driver for
	  Trusty.  This doesn't do much by itself; you'll need to enable some of
	  the sub-modules too.

	  If you build this as a module, it will be called trusty-core.

if TRUSTY

config TRUSTY_FFA_TRANSPORT
	tristate "Trusty transport based on FFA"
	depends on ARM_FFA_TRANSPORT
	default y
	help
	  Enable ARM FF-A based transport for Trusty.

	  If you want to use ARM FF-A based transport for sending Trusty messages
	  to secure world and/or performing memory sharing operations, answer Y.

	  This transport can also be used in tandem with TRUSTY_SMC_TRANSPORT
	  where the FF-A driver is used for the memory operations, while the
	  legacy SMC transport is used to call into Trusty.

config TRUSTY_SMC_TRANSPORT
	tristate
	prompt "Trusty transport based on SMC" if TRUSTY_FFA_TRANSPORT
	default y
	help
	  Enable SMC based transport for Trusty.

	  If TRUSTY_SMC_TRANSPORT_USE_FFA_TRANSPORT is also Y,
	  the SMC transport will use the firmware driver
	  and call into the memory operation implementation from
	  the FF-A transport enabled by TRUSTY_FFA_TRANSPORT.

	  If you want to use legacy SMC based transport for sending Trusty
	  messages to secure world, answer Y.

config TRUSTY_SMC_TRANSPORT_USE_FFA_TRANSPORT
	bool
	depends on TRUSTY_SMC_TRANSPORT && TRUSTY_FFA_TRANSPORT
	default y

config TRUSTY_IRQ
	bool "Trusty IRQ support"
	default y
	help
	  Enable forwarding of IRQs from Linux to Trusty.  This driver retrieves
	  from Trusty a list of IRQs that Trusty uses, and it registers handlers
	  for them which notify Trusty that the IRQ has been received.

	  If you build the trusty core driver as a module, this will be part of the
	  trusty-core module.

	  Usually this is needed for Trusty to work, so say 'y'.

config TRUSTY_LOG
	tristate "Trusty log support"
	default y
	help
	  Print log messages generated by the secure OS to the Linux kernel log.

	  While this module is loaded, messages are retrieved and printed after
	  each call into Trusty, and also during Linux kernel panics.

	  If you build this as a module, it will be called trusty-log.

config TRUSTY_TEST
	tristate "Trusty stdcall test"
	default y
	help
	  Allow running tests of the Trusty stdcall interface.  Running these
	  tests is initiated by userspace writing to a sysfs file.

	  This depends on having a test sevice running on the Trusty side.

	  If you build this as a module, it will be called trusty-test.

config TRUSTY_VIRTIO
	tristate "Trusty virtio support"
	select VIRTIO
	default y
	help
	  Enable the Trusty virtio driver, which is responsible for management
	  and interaction with virtio devices exposed by Trusty.  This driver
	  requests the virtio device descriptors from Trusty, then parses them
	  and adds the corresponding virtio devices.

	  If you build this as a module, it will be called trusty-virtio.

config TRUSTY_VIRTIO_IPC
	tristate "Trusty Virtio IPC driver"
	depends on TRUSTY_VIRTIO
	default y
	help
	  Enable support for communicating with Trusty services.

	  If you build this as a module, it will be called trusty-ipc.

config TRUSTY_VIRTIO_POLL_VQUEUES
	bool "Poll the virtio queues periodically"
	depends on TRUSTY_VIRTIO
	help
	  Add an optional timer that polls the virtio queues periodically.
	  When enabled, this will add a device attribute that configures
	  the timer period for the polling. The attribute can be set to 0
	  to disable the timer dynamically.

	  This is needed when there is no signaling mechanism between
	  Linux and Trusty for virtio, e.g., when using FF-A to talk
	  between guest VMs and TrustZone without notification support.

config TRUSTY_DMA_BUF_FFA_TAG
	bool "Availability of trusty_dma_buf_get_ffa_tag"
	default n
	help
	  Whether trusty_dma_buf_get_ffa_tag is provided on this platform.
	  Providing this function will allow the platform to select what tag
	  should be passed to the SPM when attempting to transfer the buffer
	  to secure world. The value passed here is implementation defined and
	  may depend on your SPM.

	  If set to N, a default implementation which returns 0 will be used.

config TRUSTY_DMA_BUF_SHARED_MEM_ID
	bool "Availability of trusty_dma_buf_get_shared_mem_id"
	default n
	help
	  Whether trusty_dma_buf_get_shared_mem_id is provided on this platform.
	  Providing this function allows the platform to manage memory
	  transaction life cycle of DMA bufs independently of Trusty IPC driver.
	  The latter can query trusty_shared_mem_id_t value allocated for a
	  given DMA buf using trusty_dma_buf_get_shared_mem_id interface.

	  If set to N, a default implementation which does not allocate any IDs
	  will be used.

config TRUSTY_CRASH_IS_PANIC
	bool "When trusty panics, then panic the kernel"
	help
	 This option will treat Trusty panics as fatal.  This is useful if
	 your system cannot recover from Trusty panic/halt and you require
	 the system to reboot to recover.

	 If N, it will contine to run the kernel, but trusty operations will
	 return errors.

config TRUSTY_POPULATE
	tristate "Build a module that populates the Trusty devices"
	default m
	help
	  Build a module that will register some platform devices for
	  some of the other Trusty modules that guests need to use.
	  This is useful when the device tree does or can not contain
	  the nodes we need. The devices are populated on module insertion
	  and persist until trusty-populate.ko is removed.

	  If N, the modules require device tree nodes for probing.

endif # TRUSTY

endmenu
