# SPDX-License-Identifier: BSD-2-Clause
load("@mgk_info//:dict.bzl",
    "KERNEL_VERSION")
load("//build/bazel_mgk_rules:mgk_ddk_ko.bzl", "define_mgk_ddk_ko")
load(":module_variable.bzl",
    "extra_copts",
    "extra_ko_deps",
    "extra_srcs",
    "extra_includes",
    "extra_local_defines",
    "extra_header_deps",)
load("@mgk_info//:dict.bzl", "DEFCONFIG_OVERLAYS",)

kernel_version = KERNEL_VERSION.split("-")[-1]
common_srcs = [
   "chips/common/cmm_asic_common.c",
   "chips/common/fw_dl.c",
   "chips/common/fw_log.c",
   "common/debug.c",
   "common/dump.c",
   "common/wlan_he.c",
   "common/wlan_lib.c",
   "common/wlan_oid.c",
   "common/wlan_p2p.c",
   "mgmt/aaa_fsm.c",
   "mgmt/ais_fsm.c",
   "mgmt/aps.c",
   "mgmt/arp_mon.c",
   "mgmt/assoc.c",
   "mgmt/auth.c",
   "mgmt/bss.c",
   "mgmt/ccm.c",
   "mgmt/cnm.c",
   "mgmt/cnm_mem.c",
   "mgmt/cnm_timer.c",
   "mgmt/fils.c",
   "mgmt/gcm.c",
   "mgmt/hem_mbox.c",
   "mgmt/hs20.c",
   "mgmt/ie_sort.c",
   "mgmt/mddp.c",
   "mgmt/mib.c",
   "mgmt/mlr.c",
   "mgmt/mscs.c",
   "mgmt/p2p_assoc.c",
   "mgmt/p2p_bss.c",
   "mgmt/p2p_dev_fsm.c",
   "mgmt/p2p_dev_state.c",
   "mgmt/p2p_fsm.c",
   "mgmt/p2p_func.c",
   "mgmt/p2p_ie.c",
   "mgmt/p2p_link.c",
   "mgmt/p2p_rlm.c",
   "mgmt/p2p_rlm_obss.c",
   "mgmt/p2p_role_fsm.c",
   "mgmt/p2p_role_state.c",
   "mgmt/p2p_scan.c",
   "mgmt/pasn.c",
   "mgmt/privacy.c",
   "mgmt/qosmap.c",
   "mgmt/rate.c",
   "mgmt/reg_rule.c",
   "mgmt/rlm.c",
   "mgmt/rlm_domain.c",
   "mgmt/rlm_obss.c",
   "mgmt/rlm_protection.c",
   "mgmt/rlm_tasar.c",
   "mgmt/roaming_fsm.c",
   "mgmt/rrm.c",
   "mgmt/rsn.c",
   "mgmt/rtt.c",
   "mgmt/saa_fsm.c",
   "mgmt/scan.c",
   "mgmt/scan_cache.c",
   "mgmt/scan_fsm.c",
   "mgmt/stats.c",
   "mgmt/swcr.c",
   "mgmt/tdls.c",
   "mgmt/thrm.c",
   "mgmt/tkip_mic.c",
   "mgmt/wapi.c",
   "mgmt/wlan_ring.c",
   "mgmt/wmm.c",
   "mgmt/wnm.c",
   "nic/cmd_buf.c",
   "nic/nic.c",
   "nic/nic_cmd_event.c",
   "nic/nic_pwr_mgt.c",
   "nic/nic_rate.c",
   "nic/nic_rx.c",
   "nic/nic_tx.c",
   "nic/p2p_nic.c",
   "nic/que_mgt.c",
   "nic/radiotap.c",
   "os/linux/gl_ate_agent.c",
   "os/linux/gl_cfg80211.c",
   "os/linux/gl_cmd_validate.c",
   "os/linux/gl_concurrency_matrix.c",
   "os/linux/gl_csi.c",
   "os/linux/gl_custom.c",
   "os/linux/gl_emi.c",
   "os/linux/gl_fw_log.c",
   "os/linux/gl_hook_api.c",
   "os/linux/gl_ics.c",
   "os/linux/gl_init.c",
   "os/linux/gl_kal.c",
   "os/linux/gl_met_log.c",
   "os/linux/gl_p2p.c",
   "os/linux/gl_p2p_cfg80211.c",
   "os/linux/gl_p2p_init.c",
   "os/linux/gl_p2p_kal.c",
   "os/linux/gl_proc.c",
   "os/linux/gl_qa_agent.c",
   "os/linux/gl_reg_rule.c",
   "os/linux/gl_rst.c",
   "os/linux/gl_sa_log.c",
   "os/linux/gl_sys_lock.c",
   "os/linux/gl_vendor.c",
   "os/linux/gl_vendor_logger.c",
   "os/linux/gl_wext.c",
   "os/linux/gl_wext_priv.c",
   "os/linux/hif/common/dbg_pdma.c",
   "os/linux/hif/common/hal_pdma.c",
   "os/linux/hif/common/hif_mem.c",
   "os/linux/hif/common/kal_pdma.c",
   "os/linux/platform.c",
   "os/linux/gl_plat.c",
   "wlan_service/agent/agent.c",
   "wlan_service/glue/hal/gen4m/operation_gen4m.c",
   "wlan_service/glue/osal/gen4m/net_adaption_gen4m.c",
   "wlan_service/glue/osal/gen4m/sys_adaption_gen4m.c",
   "wlan_service/service/service_test.c",
   "wlan_service/service/test_engine.c",
   "ext/common/wlan_oid_ext.c",
   "ext/mgmt/log_ext.c",
   "ext/mgmt/p2p_ext.c",
   "ext/mgmt/roaming_ext.c",
   "ext/os/linux/gl_sys.c",
   "ext/os/linux/gl_wext_priv_ext.c",
   "ext/chips/common/fw_log_emi_ext.c",
]


common_includes =  [
    "include",
    "include/chips",
    "include/mgmt",
    "include/nic",
    "include/wpa_supp",
    "os",
    "os/linux/hif/common/include",
    "os/linux/include",
    "wlan_service/glue/hal/include",
    "wlan_service/glue/osal/include",
    "wlan_service/include",
    "wlan_service/service/include",
    "ext/include",
    "ext/include/mgmt",
    "ext/include/chips",
]

def gen4m_modules(platforms):
    for p in platforms:
        print("list is: ",p)
        print("extra_srcs is: ", " ".join(extra_srcs[p]))
        print("extra_includes is: ", " ".join(extra_includes[p]))
        print("extra_local_defines is: ", " ".join(extra_local_defines[p]))
        print("common_srcs is: ", common_srcs)
        print("extra_copts is: ", " ".join(extra_copts[p]))
        print("extra_ko_deps is: ", " ".join(extra_ko_deps[p]))
        define_mgk_ddk_ko(
            name = "wlan_drv_gen4m_{}".format(p),
            srcs =  common_srcs + extra_srcs[p] + [":headers"],
            includes = common_includes + extra_includes[p],
            local_defines = [] + extra_local_defines[p],

            copts = extra_copts[p] + [
                "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/include/mt-plat/",
                "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/base/power/include/",
                "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/performance/include/",
                "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/pmic/include/",
                "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/power_throttling/",
                "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/connectivity/common",
                "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/eccci/inc/",
                "-I$(DEVICE_MODULES_PATH)/drivers/gpu/drm/mediatek/mediatek_v2/",
                "-I$(DEVICE_MODULES_PATH)/drivers/devfreq/",
                "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/mddp/include/",
                "-I$(srctree)/net",
                "-Werror",
                "-Wno-format",
                "-Wno-missing-declarations",
                "-Wno-missing-prototypes",
                "-Wno-parentheses",
                "-Wno-unused-function",
                "-Wno-unused-result",
                "-Wno-unused-value",
                "-Wno-macro-redefined",
            ],

            header_deps = extra_header_deps[p] + [
                "//kernel_device_modules-{}/drivers/misc/mediatek/power_throttling:power_throttling_headers".format(kernel_version),
                "//kernel_device_modules-{}/drivers/gpu/drm/mediatek/mediatek_v2:ddk_public_headers".format(kernel_version),
                "//kernel_device_modules-{}/drivers/misc/mediatek/mddp:mddp_headers".format(kernel_version),
                "//kernel_device_modules-{}/drivers/misc/mediatek/eccci:ccci_header".format(kernel_version),
            ] + ([ ] if "entry_level.config" in DEFCONFIG_OVERLAYS else [
                "//kernel_device_modules-{}/drivers/misc/mediatek/mbraink/bridge:mtk_mbraink_bridge_headers".format(kernel_version),
            ]),

            ko_deps = extra_ko_deps[p] + [
                "//kernel_device_modules-{}/drivers/misc/mediatek/power_throttling:pmic_lbat_service".format(kernel_version),
                "//kernel_device_modules-{}/drivers/misc/mediatek/connectivity:connadp".format(kernel_version),
                "//kernel_device_modules-{}/drivers/gpu/drm/mediatek/mediatek_v2:mtk_disp_notify".format(kernel_version),
                "//kernel_device_modules-{}/drivers/misc/mediatek/aee/aed:aee_aed".format(kernel_version),
                "//kernel_device_modules-{}/drivers/soc/mediatek:mtk-dvfsrc".format(kernel_version),
                "//kernel_device_modules-{}/drivers/misc/mediatek/mddp:mddp".format(kernel_version),
                "//kernel_device_modules-{}/drivers/misc/mediatek/eccci:ccci_md_all".format(kernel_version),
            ] + ([ ] if "entry_level.config" in DEFCONFIG_OVERLAYS else [
                "//kernel_device_modules-{}/drivers/misc/mediatek/mbraink/bridge:mtk_mbraink_bridge".format(kernel_version),
            ]),
        )
