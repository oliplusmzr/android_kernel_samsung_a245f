# SPDX-License-Identifier: GPL-2.0 WITH Linux-syscall-note
#
# (C) COPYRIGHT 2023-2025 ARM Limited. All rights reserved.
#
# This program is free software and is provided to you under the terms of the
# GNU General Public License version 2 as published by the Free Software
# Foundation, and any use by you of this program is subject to the terms
# of such GNU license.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, you can access it online at
# http://www.gnu.org/licenses/gpl-2.0.html.
#
#

load(
    "@kleaf//build/kernel/kleaf:kernel.bzl",
    "ddk_headers",
    "ddk_module",
    "kernel_module_group",
)
load("//config:cflags.bzl", "CFLAGS_MODULE")

package(
    default_visibility = [
        "//:__subpackages__",
        "@kleaf//common:__pkg__",
    ],
)

ddk_headers(
    name = "mali_kernel_headers",
    hdrs = [
        "//:kernel_headers",
        "@kleaf//common:all_headers",
    ] + glob(["**/*.h"]),
    includes = [
        ".",
        "sources",
        "sources/ela",
    ],
)

kernel_module_group(
    name = "hwtracing_coresight",
    srcs = [
        ":coresight_mali_source_ela",
        ":coresight_mali_source_etm",
        ":coresight_mali_source_itm",
    ],
)

filegroup(
    name = "hwtracing_coresight_kconfig",
    srcs = ["Kconfig"],
)

filegroup(
    name = "coresight_mali_defaults",
    srcs = [
        "coresight_mali_common.c",
        "coresight_mali_common.h",
    ],
)

filegroup(
    name = "coresight_mali_source_defaults",
    srcs = [
        "sources/coresight_mali_sources.c",
        "sources/coresight_mali_sources.h",
    ],
)

ddk_module(
    name = "coresight_mali_source_ela",
    srcs = [
        "sources/ela/coresight-ela600.h",
        "sources/ela/coresight_mali_source_ela_core.c",
        ":coresight_mali_defaults",
        ":coresight_mali_source_defaults",
    ],
    out = "coresight_mali_source_ela.ko",
    hdrs = [
        ":mali_kernel_headers",
    ],
    copts = CFLAGS_MODULE,
    kconfig = ":hwtracing_coresight_kconfig",
    kernel_build = "@kleaf//common:kernel_aarch64",
    deps = ["//drivers/gpu/arm/midgard:mali_kbase"],
)

ddk_module(
    name = "coresight_mali_source_itm",
    srcs = [
        "sources/itm/coresight_mali_source_itm_core.c",
        ":coresight_mali_defaults",
        ":coresight_mali_source_defaults",
    ],
    out = "coresight_mali_source_itm.ko",
    hdrs = [
        ":mali_kernel_headers",
    ],
    copts = CFLAGS_MODULE,
    kconfig = ":hwtracing_coresight_kconfig",
    kernel_build = "@kleaf//common:kernel_aarch64",
    deps = ["//drivers/gpu/arm/midgard:mali_kbase"],
)

ddk_module(
    name = "coresight_mali_source_etm",
    srcs = [
        "sources/etm/coresight_mali_source_etm_core.c",
        ":coresight_mali_defaults",
        ":coresight_mali_source_defaults",
    ],
    out = "coresight_mali_source_etm.ko",
    hdrs = [
        ":mali_kernel_headers",
    ],
    copts = CFLAGS_MODULE,
    kconfig = ":hwtracing_coresight_kconfig",
    kernel_build = "@kleaf//common:kernel_aarch64",
    deps = ["//drivers/gpu/arm/midgard:mali_kbase"],
)

