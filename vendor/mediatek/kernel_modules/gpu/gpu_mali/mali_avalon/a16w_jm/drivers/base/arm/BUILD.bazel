# SPDX-License-Identifier: GPL-2.0 WITH Linux-syscall-note
#
# (C) COPYRIGHT 2023-2025 ARM Limited. All rights reserved.
#
# This program is free software and is provided to you under the terms of the
# GNU General Public License version 2 as published by the Free Software
# Foundation, and any use by you of this program is subject to the terms
# of such GNU license.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, you can access it online at
# http://www.gnu.org/licenses/gpl-2.0.html.
#
#
load(
    "//build/bazel_mgk_rules:mgk_ddk_ko.bzl",
        "define_mgk_ddk_ko",
)

load(
    "//build/kernel/kleaf:kernel.bzl",
    "kernel_module_group",
    "ddk_headers"
)

load("//vendor/mediatek/kernel_modules/gpu/gpu_mali/mali_avalon/a16w_jm/config:cflags.bzl", "CFLAGS_MODULE")
load("@mgk_info//:kernel_version.bzl", "kernel_version")

package(
    default_visibility = [
        "//visibility:public",
    ],
)

filegroup(
    name = "ddk_kconfigs",
    srcs = glob([
        "**/Kconfig",
    ]),
)

ddk_headers(
    name = "mali_kernel_headers",
    hdrs = [
        "//vendor/mediatek/kernel_modules/gpu/gpu_mali/mali_avalon/a16w_jm:kernel_headers",
        "//vendor/mediatek/kernel_modules/gpu/gpu_mali/mali_avalon/a16w_jm/drivers/gpu/arm/midgard:midgard_headers",
    ],
)
kernel_module_group(
    name = "base",
    srcs = [
               ":memory_group_manager",
           ] + select({
               "//vendor/mediatek/kernel_modules/gpu/gpu_mali/mali_avalon/a16w_jm/config:dma_shared_buffer": [
                   ":dma-buf-test-exporter",
               ],
               "//conditions:default": [],
           }) +
           select({
               "//vendor/mediatek/kernel_modules/gpu/gpu_mali/mali_avalon/a16w_jm/config:csf_supported": [
                   ":protected_memory_allocator",
               ],
               "//conditions:default": [],
           }),
)
filegroup(
    name = "base_kconfig",
    srcs = ["Kconfig"],
)
platforms = [
    "mt6789",
]

[define_mgk_ddk_ko(
    name = "mali_dmabuf_test_{}_a16w_jm".format(p),
    srcs = glob(["dma_buf_test_exporter/*.c"]),
    out = "mali_dmabuf_test_{}_a16w_jm.ko".format(p),
    hdrs = [":mali_kernel_headers"],
    copts = CFLAGS_MODULE,
    defconfig = "//vendor/mediatek/kernel_modules/gpu/gpu_mali/mali_avalon/a16w_jm/config/fragment:base_defconfig",
    kconfig = ":base_kconfig",
) for p in platforms]

[define_mgk_ddk_ko(
    name = "mali_mgm_{}_a16w_jm".format(p),
    srcs = glob(["memory_group_manager/*.c"]),
    out = "mali_mgm_{}_a16w_jm.ko".format(p),
    hdrs = [":mali_kernel_headers"],
    ko_deps = [
        "//kernel_device_modules-{}/drivers/dma-buf/heaps:system_heap".format(kernel_version),
        "//kernel_device_modules-{}/drivers/dma-buf/heaps:mtk_sec_heap".format(kernel_version),
		"//kernel_device_modules-{}/drivers/memory/mediatek:emi".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/slbc:mtk_slbc".format(kernel_version),
    ],
    copts = CFLAGS_MODULE + [
        "-I$(srctree)/drivers/dma-buf/heaps",
        "-I$(srctree)/drivers/misc/mediatek/slbc",
    ],
    defconfig = "//vendor/mediatek/kernel_modules/gpu/gpu_mali/mali_avalon/a16w_jm/config/fragment:base_defconfig",
    kconfig = ":base_kconfig",
    local_defines = [
        "CONFIG_MALI_MTK_PREVENT_PRINTK_TOO_MUCH",
    ]
    + ([
        "CONFIG_MALI_MTK_MGMM",
    ] if p in ["mt6789"] else[]),
) for p in platforms]

[define_mgk_ddk_ko(
    name = "mali_prot_alloc_{}_a16w_jm".format(p),
    srcs = glob(["protected_memory_allocator/*.c"]),
    out = "mali_prot_alloc_{}_a16w_jm.ko".format(p),
    hdrs = [":mali_kernel_headers"],
    header_deps = [
        "//kernel_device_modules-{}/drivers/gpu/mediatek/gpufreq/v2_legacy:gpufreq_public_headers".format(kernel_version),
        "//kernel_device_modules-{}/drivers/gpu/mediatek/gpufreq:mtk_gpufreq_headers".format(kernel_version),
        "//kernel_device_modules-{}/drivers/misc/mediatek/trusted_mem:tmem_hdrs".format(kernel_version),
    ],
    ko_deps = [
        "//kernel_device_modules-{}/drivers/dma-buf/heaps:mtk_sec_heap".format(kernel_version),
	"//kernel_device_modules-{}/drivers/gpu/mediatek/gpufreq/v2_legacy:mtk_gpufreq_wrapper_legacy".format(kernel_version),
	"//kernel_device_modules-{}/drivers/misc/mediatek/trusted_mem:trusted_mem".format(kernel_version),
    ],
    copts = CFLAGS_MODULE + [
        "-I$(srctree)/drivers/dma-buf/heaps",
        "-I$(DEVICE_MODULES_PATH)/drivers/misc/mediatek/trusted_mem/public",
    ] + ([
        "-I$(srctree)/drivers/gpu/mediatek/gpufreq",
    ] if p in ["mt6789"] else[]),
    defconfig = "//vendor/mediatek/kernel_modules/gpu/gpu_mali/mali_avalon/a16w_jm/config/fragment:base_defconfig",
    kconfig = ":base_kconfig",
    local_defines = [
        "CONFIG_MALI_MTK_GPU_PROTECTED_MEMORY_SUPPORT",
    ]
    + ([
        "CONFIG_MALI_MTK_GPU_IOMMU=0",
        "CONFIG_MALI_MTK_GPU_PMA_PAGE_HEAP=0",
    ] if p in ["mt6789"] else []),
) for p in platforms]
